<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project name="org.genesez.documentation" basedir=".." default="all">

	<!-- determine correct environment properties -->
	<condition property="environment.properties"
		value="environment.properties"
		else="environment.default.properties">
		<available file="build/environment.properties" />
	</condition>
	
	<property file="build/${environment.properties}" />
	<property file="build/project.properties" />
	

	<condition property="build.display"
		value="${env.DISPLAY}"
		else=":1">
		<isset property="env.DISPLAY" />
	</condition>

	<path id="org.genesez.documentation.classpath">
		<pathelement location="lib" />
		<pathelement location="${xalan.dir}" />
		<pathelement location="${xalan.dir}/xalan.jar" />
		<pathelement location="${xalan.dir}/xml-apis.jar" />
		<pathelement location="${xalan.dir}/xercesImpl.jar" />
		<pathelement location="${xalan.dir}/xalan.jar" />
		<pathelement location="${docbook.xsl.dir}/extensions/xalan27.jar" />
		<pathelement location="${resolver.dir}/resolver.jar" />
		<pathelement location="${fop.dir}/build/fop.jar" />
		<pathelement location="${fop.dir}/lib/avalon-framework-4.2.0.jar" />
		<pathelement location="${fop.dir}/lib/batik-all-1.7.jar" />
		<pathelement location="${fop.dir}/lib/commons-io-1.3.1.jar" />
		<pathelement location="${fop.dir}/lib/commons-logging-1.0.4.jar" />
		<pathelement location="${fop.dir}/lib/serializer-2.7.0.jar" />
		<pathelement location="${fop.dir}/lib/xml-apis-1.3.04.jar" />
		<pathelement location="${fop.dir}/lib/xml-apis-ext-1.3.04.jar" />
		<pathelement location="${fop.dir}/lib/xmlgraphics-commons-1.4.jar" />
	</path>
	
	<fileset id="docbook.files" dir="${basedir}/docbook" includes="**/*.xml" />
	
	<!-- Public target section -->
	
	<target name="all" depends="build, distribute" description="Builds + distributes all GeneSEZ docmentation" />
	<target name="build" depends="javaee, genesez-en, genesez-de, php" description="Build all GeneSEZ documentation" />
	
	<!-- java ee manual -->
	<target name="javaee" depends="javaee2html, javaee2pdf" />
	
	<target name="javaee.xinclude" description="creates the single xml file for genesez javaee manual">
		<mkdir dir="${temp.dir}" />
		<antcall target="xinclude.processing">
			<param name="temp.file" value="${temp.dir}/java.ee.manual.xml" />
			<param name="src.file" value="${basedir}/docbook/assemblies/java.ee.manual.xml" />
		</antcall>
	</target>
	
	<target name="javaee2html" depends="javaee.xinclude">
		<mkdir dir="${html.javaee.dir}" />
		<antcall target="docbook2html">
			<param name="src.file" value="${temp.dir}/java.ee.manual.xml" />
			<param name="out.file" value="${html.javaee.dir}/index.html" />
			<param name="xsl.file" value="${docbook2html}" />
		</antcall>
		<copy todir="${html.javaee.dir}" flatten="true">
			<fileset dir="${basedir}/images/core" includes="**/*.png" />
			<fileset dir="${basedir}/images/java" includes="**/*.png" />
			<fileset dir="${basedir}/images/uml" includes="**/*.png" />
			<fileset dir="${basedir}/images/profiles" includes="**/*.png" />
		</copy>
	</target>
	
	<target name="javaee2pdf" depends="javaee.xinclude">
		<mkdir dir="${pdf.dir}" />
		<antcall target="docbook2pdf">
			<param name="base.dir" value="${basedir}/images" />
			<param name="src.file" value="${temp.dir}/java.ee.manual.xml" />
			<param name="fo.file" value="${temp.dir}/java.ee.manual.fo" />
			<param name="pdf.file" value="${pdf.dir}/java.ee.manual.pdf" />
			<param name="xsl.file" value="${docbook2fo}" />
		</antcall>
	</target>
	
	<!-- english genesez manual -->
	<target name="genesez-en" depends="genesez2html, genesez2pdf" />
	
	<target name="genesez.xinclude" description="creates the single xml file for genesez javaee manual">
		<mkdir dir="${temp.dir}" />
		<antcall target="xinclude.processing">
			<param name="temp.file" value="${temp.dir}/genesez.en.xml" />
			<param name="src.file" value="${basedir}/docbook/assemblies/genesez.manual.xml" />
		</antcall>
	</target>
	
	<target name="genesez2html" depends="genesez.xinclude">
		<mkdir dir="${html.genesez.en.dir}" />
		<antcall target="docbook2html">
			<param name="src.file" value="${temp.dir}/genesez.en.xml" />
			<param name="out.file" value="${html.genesez.en.dir}/index.html" />
			<param name="xsl.file" value="${docbook2html}" />
		</antcall>
		<antcall target="copy.css">
			<param name="dest.dir" value="${html.genesez.en.dir}" />
		</antcall>
		<antcall target="copy.images">
			<param name="dest.dir" value="${html.genesez.en.dir}" />
		</antcall>
	</target>
	
	<target name="genesez2singlehtml" depends="genesez.xinclude">
		<mkdir dir="${html.single.dir}" />
		<antcall target="docbook2html">
			<param name="src.file" value="${temp.dir}/genesez.en.xml" />
			<param name="out.file" value="${html.single.dir}/index.html" />
			<param name="xsl.file" value="${docbook2singlehtml}" />
		</antcall>
		<antcall target="copy.css">
			<param name="dest.dir" value="${html.single.dir}" />
		</antcall>
		<antcall target="copy.images">
			<param name="dest.dir" value="${html.single.dir}" />
		</antcall>
	</target>
	
	<target name="genesez2pdf" depends="genesez.xinclude">
		<mkdir dir="${pdf.dir}" />
		<antcall target="docbook2pdf">
			<param name="base.dir" value="${basedir}/images" />
			<param name="src.file" value="${temp.dir}/genesez.en.xml" />
			<param name="fo.file" value="${temp.dir}/genesez.en.fo" />
			<param name="pdf.file" value="${pdf.dir}/genesez_en.pdf" />
			<param name="xsl.file" value="${docbook2fo}" />
		</antcall>
	</target>
	
	<!-- german genesez manual -->
	<target name="genesez-de" depends="manual2html, manual2pdf" />
	
	<target name="manual.xinclude" description="creates the single xml file for the genesez manual">
		<mkdir dir="${temp.dir}" />
		<antcall target="xinclude.processing">
			<param name="src.file" value="${basedir}/docbook/assemblies/genesez.manual_de.xml" />
			<param name="temp.file" value="${temp.dir}/genesez.manual_de.xml" />
		</antcall>
	</target>
	
	<target name="manual2html" depends="manual.xinclude">
		<mkdir dir="${html.genesez.dir}" />
		<antcall target="docbook2html">
			<param name="src.file" value="${temp.dir}/genesez.manual_de.xml" />
			<param name="out.file" value="${html.genesez.dir}/index.html" />
			<param name="xsl.file" value="${docbook2html}" />
		</antcall>
		<copy todir="${html.genesez.dir}" flatten="true">
			<fileset dir="${basedir}/images" includes="*.png" />
			<fileset dir="${basedir}/images/core" includes="**/*.png" />
			<fileset dir="${basedir}/images/java" includes="**/*.png" />
			<fileset dir="${basedir}/images/php" includes="**/*.png" />
			<fileset dir="${basedir}/images/uml" includes="**/*.png" />
			<fileset dir="${basedir}/images/profiles" includes="**/*.png" />
		</copy>
	</target>
	
	<target name="manual2pdf" depends="manual.xinclude">
		<mkdir dir="${pdf.dir}" />
		<antcall target="docbook2pdf">
			<param name="base.dir" value="${basedir}/images" />
			<param name="src.file" value="${temp.dir}/genesez.manual_de.xml" />
			<param name="fo.file" value="${temp.dir}/genesez.manual_de.fo" />
			<param name="pdf.file" value="${pdf.dir}/genesez_de.pdf" />
			<param name="xsl.file" value="${docbook2fo}" />
		</antcall>
	</target>
	
	
	<!-- php manual -->
	<target name="php" depends="php2html, php2pdf" />
	
	<target name="php.xinclude" description="creates the single xml file for genesez javaee manual">
		<mkdir dir="${temp.dir}" />
		<antcall target="xinclude.processing">
			<param name="temp.file" value="${temp.dir}/php.manual_de.xml" />
			<param name="src.file" value="${basedir}/docbook/assemblies/php.manual_de.xml" />
		</antcall>
	</target>
	
	<target name="php2html" depends="php.xinclude">
		<mkdir dir="${html.php.dir}" />
		<antcall target="docbook2html">
			<param name="src.file" value="${temp.dir}/php.manual_de.xml" />
			<param name="out.file" value="${html.php.dir}/index.html" />
			<param name="xsl.file" value="${docbook2html}" />
		</antcall>
		<copy todir="${html.php.dir}" flatten="true">
			<fileset dir="${basedir}/images/core" includes="**/*.png" />
			<fileset dir="${basedir}/images/php" includes="**/*.png" />
			<fileset dir="${basedir}/images/uml" includes="**/*.png" />
			<fileset dir="${basedir}/images/profiles" includes="**/*.png" />
		</copy>
	</target>
	
	<target name="php2pdf" depends="php.xinclude">
		<mkdir dir="${pdf.dir}" />
		<antcall target="docbook2pdf">
			<param name="base.dir" value="${basedir}/images" />
			<param name="src.file" value="${temp.dir}/php.manual_de.xml" />
			<param name="fo.file" value="${temp.dir}/php.manual_de.fo" />
			<param name="pdf.file" value="${pdf.dir}/php.manual_de.pdf" />
			<param name="xsl.file" value="${docbook2fo}" />
		</antcall>
	</target>
	
	
	<!-- other targets -->
	
	<target name="copy.css" description="Copies all css stylesheets to the specified dest.dir">
		<copy todir="${dest.dir}" flatten="true">
			<fileset dir="${basedir}/build" includes="*.css" />
		</copy>
	</target>
	
	<target name="copy.images" description="Copies all images to the specified dest.dir">
		<copy todir="${dest.dir}" flatten="true">
			<fileset dir="${basedir}/images/core" includes="**/*.png" />
			<fileset dir="${basedir}/images/java" includes="**/*.png" />
			<fileset dir="${basedir}/images/developer" includes="**/*.png" />
			<fileset dir="${basedir}/images/uml" includes="**/*.png" />
			<fileset dir="${basedir}/images/profiles" includes="**/*.png" />
		</copy>
	</target>
	
	<target name="distribute" description="Distribute GeneSEZ documentation">
		<delete includeemptydirs="true">
			<fileset dir="${distribution.dir}" includes="**/*"/>
  		</delete>
		<mkdir dir="${distribution.dir}/javaee"/>
		<copy todir="${distribution.dir}/javaee">
			<fileset dir="${html.javaee.dir}" />
		</copy>
		<mkdir dir="${distribution.dir}/genesez"/>
		<copy todir="${distribution.dir}/genesez">
			<fileset dir="${html.genesez.en.dir}" includes="**" />
		</copy>
		<mkdir dir="${distribution.dir}/all"/>
		<copy todir="${distribution.dir}/all">
			<fileset dir="${html.single.dir}" includes="**" />
		</copy>
		<mkdir dir="${distribution.dir}/manual"/>
		<copy todir="${distribution.dir}/manual">
			<fileset dir="${html.genesez.dir}" includes="**" />
		</copy>
		<mkdir dir="${distribution.dir}/php"/>
		<copy todir="${distribution.dir}/php">
			<fileset dir="${html.php.dir}" />
		</copy>
		<!-- pdf's -->
		<copy todir="${distribution.dir}">
			<fileset dir="${pdf.dir}" includes="*.pdf" />
		</copy>
		<!-- website -->
		<copy todir="${distribution.dir}">
			<fileset dir="${website.dir}" includes="**" />
		</copy>
		
		<chmod perm="u=rwX,g=rwX,o=" dir="${distribution.dir}" includes="**/*" type="both" />
		<chgrp group="wwwcln" type="both">
			<fileset dir="${distribution.dir}" includes="**/*" />
		</chgrp>
	</target>

	<target name="clean"
		description="Clean org.genesez.documentation">
		<delete dir="${temp.dir}" />
		<delete dir="${dist.dir}" />
	</target>
	
	<target name="encode.xincludes" description="encode xincludes to get editable xml files for vex">
		<replaceregexp flags="g">
			<fileset refid="docbook.files" />
			<regexp pattern="${regexpEncodeWxpointer}" />
			<substitution expression="${replaceEncodeWxpointer}" />
		</replaceregexp>
		<replaceregexp flags="g">
			<fileset refid="docbook.files" />
			<regexp pattern="${regexpEncodeWoXpointer}" />
			<substitution expression="${replaceEncodeWoXpointer}" />
		</replaceregexp>
	</target>
	
	<target name="decode.xincludes" description="decode xincludes to get transformable xml files for docbook xsl">
		<replaceregexp flags="g">
			<fileset refid="docbook.files" />
			<regexp pattern="${regexpDecodeWxpointer}" />
			<substitution expression="${replaceDecodeWxpointer}" />
		</replaceregexp>
		<replaceregexp flags="g">
			<fileset refid="docbook.files" />
			<regexp pattern="${regexpDecodeWoXpointer}" />
			<substitution expression="${replaceDecodeWoXpointer}" />
		</replaceregexp>
	</target>
	
	<target name="replace.umlauts" description="replace umlauts in docbook files">
		<replace dir="${basedir}">
			<include name="*.xml" />
			<replacetoken>ä</replacetoken>
			<replacevalue><![CDATA[&auml;]]></replacevalue>
		</replace>
		<replace dir="${basedir}">
			<include name="*.xml" />
			<replacetoken>ö</replacetoken>
			<replacevalue><![CDATA[&ouml;]]></replacevalue>
		</replace>
		<replace dir="${basedir}">
			<include name="*.xml" />
			<replacetoken>ü</replacetoken>
			<replacevalue><![CDATA[&uuml;]]></replacevalue>
		</replace>
		<replace dir="${basedir}">
			<include name="*.xml" />
			<replacetoken>Ä</replacetoken>
			<replacevalue><![CDATA[&Auml;]]></replacevalue>
		</replace>
		<replace dir="${basedir}">
			<include name="*.xml" />
			<replacetoken>Ü</replacetoken>
			<replacevalue><![CDATA[&Uuml;]]></replacevalue>
		</replace>
		<replace dir="${basedir}">
			<include name="*.xml" />
			<replacetoken>Ö</replacetoken>
			<replacevalue><![CDATA[&Ouml;]]></replacevalue>
		</replace>
		<replace dir="${basedir}">
			<include name="*.xml" />
			<replacetoken>ß</replacetoken>
			<replacevalue><![CDATA[&szlig;]]></replacevalue>
		</replace>
	</target>

	<!-- Private target section -->

	<target name="xinclude.processing" description="processes x-includes and creates a temporary xml files">
		<exec executable="${xmllint.bin}" dir="${basedir}">
			<env key="XML_CATALOG_FILES" value="${xml.catalogs}" />
			<arg value="--nonet"/>
			<arg value="--xinclude"/>
			<arg value="--output"/>
			<arg value="${temp.file}"/>
			<arg value="${src.file}" />
		</exec>
	</target>
	
	<target name="docbook2html">
		<dirname property="html.dir" file="${docbook.html}" />
		<mkdir dir="${html.dir}" />
		<java classname="org.apache.xalan.xslt.Process" classpathref="org.genesez.documentation.classpath">
			<arg value="-ENTITYRESOLVER" />
			<arg value="org.apache.xml.resolver.tools.CatalogResolver" />
			<arg value="-URIRESOLVER" />
			<arg value="org.apache.xml.resolver.tools.CatalogResolver" />
			<arg value="-out" />
			<arg value="${out.file}" />
			<arg value="-in" />
			<arg value="${src.file}" />
			<arg value="-xsl" />
			<arg value="${xsl.file}" />
		</java>
	</target>
	
	<target name="docbook2pdf">
		<dirname property="fo.dir" file="${fo.file}" />
		<mkdir dir="${fo.dir}" />
		<java classname="org.apache.xalan.xslt.Process" classpathref="org.genesez.documentation.classpath">
			<arg value="-ENTITYRESOLVER" />
			<arg value="org.apache.xml.resolver.tools.CatalogResolver" />
			<arg value="-URIRESOLVER" />
			<arg value="org.apache.xml.resolver.tools.CatalogResolver" />
			<arg value="-out" />
			<arg value="${fo.file}" />
			<arg value="-in" />
			<arg value="${src.file}" />
			<arg value="-xsl" />
			<arg value="${xsl.file}" />
		</java>
		<taskdef name="fop" classname="org.apache.fop.tools.anttasks.Fop" classpathref="org.genesez.documentation.classpath">
		</taskdef>
		<dirname property="pdf.dir" file="${pdf.file}" />
		<mkdir dir="${pdf.dir}" />
		<fop fofile="${fo.file}" outfile="${pdf.file}" format="application/pdf" basedir="${base.dir}">
		</fop>
		<!-- java classname="org.apache.fop.cli.Main" classpathref="org.genesez.documentation.classpath">
			<arg value="-fo" />
			<arg value="${fo.file}" />
			<arg value="-pdf" />
			<arg value="${pdf.file}" />
			<arg value="-param" />
			<arg value="use.extension" />
			<arg value="1" />
			<arg value="-param" />
			<arg value="fop1.extensions" />
			<arg value="1" />
		</java -->
	</target>
</project>

<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<project name="de.genesez.manual" basedir=".." default="build">

	<!-- Import project related properties -->
	<property file="build/build.properties" />

	<condition property="build.display"
		value="${env.DISPLAY}"
		else=":1">
		<isset property="env.DISPLAY" />
	</condition>

	<!-- Public target section -->

	<target name="build"
		description="Build de.genesez.manual"
		depends="manual.db2html, manual.fop2pdf" >
	</target>

	<target name="distribute"
		description="Distribute de.genesez.manual"
		depends="build" >
		<copy todir="${distribution.dir}">
			<fileset dir="${basedir}">
				<include name="${html.dir}/*" />
			</fileset>
		</copy>
		<copy todir="${distribution.dir}/${html.dir}">
			<fileset dir="${basedir}">
				<include name="${images.dir}/*" />
			</fileset>
		</copy>
		<copy todir="${distribution.dir}" file="${docbook.pdf}"/>
	</target>

	<target name="clean"
		description="Clean de.genesez.manual">
		<delete>
			<fileset dir="${basedir}" includes="${docbook.fo}"/>
			<fileset dir="${basedir}" includes="${docbook.pdf}"/>
			<fileset dir="${basedir}" includes="${docbook.tmp}"/>
		</delete>
		<delete dir="${basedir}/${html.dir}" />
	</target>
	
	<target name="replace.umlauts" description="replace umlauts in docbook files">
		<replace dir="${basedir}">
			<include name="*.xml" />
			<replacetoken>ä</replacetoken>
			<replacevalue><![CDATA[&auml;]]></replacevalue>
		</replace>
		<replace dir="${basedir}">
			<include name="*.xml" />
			<replacetoken>ö</replacetoken>
			<replacevalue><![CDATA[&ouml;]]></replacevalue>
		</replace>
		<replace dir="${basedir}">
			<include name="*.xml" />
			<replacetoken>ü</replacetoken>
			<replacevalue><![CDATA[&uuml;]]></replacevalue>
		</replace>
		<replace dir="${basedir}">
			<include name="*.xml" />
			<replacetoken>Ä</replacetoken>
			<replacevalue><![CDATA[&Auml;]]></replacevalue>
		</replace>
		<replace dir="${basedir}">
			<include name="*.xml" />
			<replacetoken>Ü</replacetoken>
			<replacevalue><![CDATA[&Uuml;]]></replacevalue>
		</replace>
		<replace dir="${basedir}">
			<include name="*.xml" />
			<replacetoken>Ö</replacetoken>
			<replacevalue><![CDATA[&Ouml;]]></replacevalue>
		</replace>
		<replace dir="${basedir}">
			<include name="*.xml" />
			<replacetoken>ß</replacetoken>
			<replacevalue><![CDATA[&szlig;]]></replacevalue>
		</replace>
	</target>

	<!-- Private target section -->

	<target name="manual">
		<exec executable="${xmllint.bin}">
			<arg value="--xinclude"/>
			<arg value="--output"/>
			<arg value="${docbook.tmp}"/>
			<arg value="${docbook.src}" />
		</exec>
	</target>
	
	<target name="manual.db2html"
		depends="manual">
		<mkdir dir="${basedir}/${html.dir}" />
		<exec executable="${docbook2html.bin}">
			<arg value="--output"/>
			<arg value="${html.dir}"/>
			<arg value="${docbook.tmp}"/>
		</exec>
	</target>

	<target name="manual.db2fop">
		<exec executable="${xsltproc.bin}">
			<arg value="--output"/>
			<arg value="${docbook.fo}"/>
			<arg value="${docbook2fop}"/>
			<arg value="${docbook.tmp}"/>
		</exec>
	</target>

	<target name="manual.fop2pdf"
		depends="manual.db2fop">
		<parallel>
			<antcall target="manual.startx" />
			<sequential>
				<sleep seconds="5" />
				<exec executable="${fop.bin}">
					<env key="DISPLAY" value="${build.display}" />
					<arg value="-fo"/>
					<arg value="${docbook.fo}"/>
					<arg value="-pdf"/>
					<arg value="${docbook.pdf}"/>
				</exec>
				<antcall target="manual.endx" />
			</sequential>
		</parallel>
	</target>

	<target name="manual.startx" unless="env.DISPLAY">
		<exec executable="${STARTPROC_BIN}" osfamily="unix">
			<arg value="${XVFB_BIN}" />
			<arg value="${build.display}" />
			<arg value="-screen" />
			<arg value="0" />
			<arg value="800x600x8" />
		</exec>
	</target>

	<target name="manual.endx" unless="env.DISPLAY">
		<exec executable="${KILLPROC_BIN}" osfamily="unix">
			<arg value="${XVFB_BIN}" />
		</exec>
	</target>

</project>

«REM»
	Template for jpa annotations according to associations
	
	@author		andre pflueger
	@date		2008/09/08

«ENDREM»

«REM» based on genesez meta model «ENDREM»
«IMPORT gcore»

«REM» useful metamodel extensions «ENDREM»
«EXTENSION de::genesez::platforms::common::AccessHelper»
«EXTENSION de::genesez::platforms::java::scripts::Conversion»
«EXTENSION de::genesez::platforms::java::jpa::scripts::Stereotypes»


«REM»
	private functions
«ENDREM»


«REM» 
	evaluates the associations
«ENDREM»
«DEFINE _Annotation FOR MAssociationRole-»
	«EXPAND _EvaluateAssociationStereotype»
«ENDDEFINE»

«DEFINE _EvaluateAssociationStereotype FOR MAssociationRole-»
	«IF hasStereotype("jpaAssociation") && !hasTaggedValue("jpaAssociation", "type", "AutoDetect") && hasUtilizableValue("jpaAssociation", "type")-»
		@«getTaggedValue("jpaAssociation", "type")-»«EXPAND _EvaluateAssociationTaggedValues-»
		«IF !hasTaggedValue("jpaAssociation", "type", "OneToOne")-»
			«EXPAND _JoinTable»
		«ENDIF-»
	«ELSEIF !hasStereotype("jpaAssociation") || !hasUtilizableValue("jpaAssociation", "type")-»
		«IF multiplicity != 1-»
			«REM»//Stereotypen: «this.stereotype»«ENDREM»
			@org.hibernate.annotations.CollectionOfElements
		«ENDIF-»
	«ENDIF»
«ENDDEFINE»

«REM»
	evaluates the taggedValues of the stereotype jpaAssociation
«ENDREM»
«DEFINE _EvaluateAssociationTaggedValues FOR MAssociationRole-»	
	(cascade={
	«IF hasUtilizableValue("jpaAssociation", "cascade")-»
		«FOREACH getTaggedValue("jpaAssociation", "cascade").getElements() AS cascades SEPARATOR ", "-»
			CascadeType.«cascades-»
		«ENDFOREACH-»
	«ENDIF-»}
	«IF hasUtilizableValue("jpaAssociation", "targetEntity")-»
		, targetEntity="«getTaggedValue("jpaAssociation", "targetEntity")-»"
	«ENDIF-»
	«IF !hasTaggedValue("jpaAssociation", "fetch", "DEFAULT") && hasUtilizableValue("jpaAssociation", "fetch")-»
		, fetch=FetchType.«getTaggedValue("jpaAssociation", "fetch")-»
	«ENDIF-»
	«IF ( hasTaggedValue("jpaAssociation", "type", "OneToOne") && hasTaggedValue("jpaAssociation", "optional", "false") )-»
		, optional=false
	«ENDIF-»
	«IF !hasTaggedValue("jpaAssociation", "type", "ManyToOne")-»
		«IF hasTaggedValue("jpaAssociation", "mappedBy", "true")-»
			, mappedBy="«this.opposite.name-»"
		«ENDIF-»
	«ENDIF-»)
«ENDDEFINE»

«REM» 
	evaluates the stereotype jpaJoinColumn 
	complete this define block by adding evaluation of multiple values
«ENDREM»
«DEFINE _JoinColumn FOR MAssociationRole-»
	«IF hasStereotype("jpaJoinColumn")»
		«IF hasUtilizableValue("jpaJoinColumn", "name")»
			@JoinColumn(name="«getTaggedValue("jpaJoinColumn", "name")-»"
			«IF hasUtilizableValue("jpaJoinColumn", "referencedName")-»
				, referencedColumnName="«getTaggedValue("jpaJoinColumn", "referencedName")-»"
			«ENDIF-»
			«IF hasUtilizableValue("jpaJoinColumn", "table")-»
				, table="«getTaggedValue("jpaJoinColumn", "table")-»"
			«ENDIF-»
			«IF hasUtilizableValue("jpaJoinColumn", "columnDefinition")-»
				, columnDefinition="«getTaggedValue("jpaJoinColumn", "columnDefinition")-»"
			«ENDIF-»
			«IF hasTaggedValue("jpaJoinColumn", "nullable", "false") && !hasTaggedValue("jpaJoinColumn", "unique", "true")-»
				, nullable=«getTaggedValue("jpaJoinColumn", "nullable")-»
			«ENDIF-»
			«IF hasTaggedValue("jpaJoinColumn", "insertable", "false")-»
				, insertable=false
			«ENDIF-»
			«IF hasTaggedValue("jpaJoinColumn", "updatable", "false")-»
				, updatable=false
			«ENDIF-»
			«IF hasTaggedValue("jpaJoinColumn", "unique", "true")-»-»
				, unique=true, nullable=false
			«ENDIF-»
			)
		«ENDIF»
	«ENDIF»
«ENDDEFINE»

«REM» 
	evaluates the stereotype jpaIJoinColumn 
	complete this define block by adding evaluation of multiple values
«ENDREM»
«DEFINE _IJoinColumn FOR MAssociationRole-»
	«IF hasStereotype("jpaIJoinColumn")»
		«IF hasUtilizableValue("jpaIJoinColumn", "name")»
			@JoinColumn(name="«getTaggedValue("jpaIJoinColumn", "name")-»"
			«IF hasUtilizableValue("jpaIJoinColumn", "referencedName")-»
				, referencedColumnName="«getTaggedValue("jpaIJoinColumn", "referencedName")-»"
			«ENDIF-»
			«IF hasUtilizableValue("jpaIJoinColumn", "table")-»
				, table="«getTaggedValue("jpaIJoinColumn", "table")-»"
			«ENDIF-»
			«IF hasUtilizableValue("jpaJoinColumn", "columnDefinition")-»
				, columnDefinition="«getTaggedValue("jpaIJoinColumn", "columnDefinition")-»"
			«ENDIF-»
			«IF hasTaggedValue("jpaIJoinColumn", "nullable", "false") && !hasTaggedValue("jpaIJoinColumn", "unique", "true")-»
				, nullable=«getTaggedValue("jpaIJoinColumn", "nullable")-»
			«ENDIF-»
			«IF hasTaggedValue("jpaIJoinColumn", "insertable", "false")-»
				, insertable=false
			«ENDIF-»
			«IF hasTaggedValue("jpaIJoinColumn", "updatable", "false")-»
				, updatable=false
			«ENDIF-»
			«IF hasTaggedValue("jpaIJoinColumn", "unique", "true")-»-»
				, unique=true, nullable=false
			«ENDIF-»
			)
		«ENDIF»
	«ENDIF»
«ENDDEFINE»

«REM» 
	evaluates the stereotype jpaJoinTable 
«ENDREM»
«DEFINE _JoinTable FOR MAssociationRole-»
	«IF hasStereotype("jpaJoinTable")»
		@JoinTable(name="«IF hasUtilizableValue("jpaJoinTable", "name")-»«getTaggedValue("jpaJoinTable", "name")-»"«ELSE-»tbl_«this.classifier.name.toFirstUpper()-»_tbl_«this.name-»"«ENDIF-»
		«IF hasStereotype("jpaJoinColumn")-»
			, joinColumns=
			«EXPAND _JoinColumn-»
		«ENDIF-»
		«IF hasStereotype("jpaIJoinColumn")-»
			, inverseJoinColumns=
			«EXPAND _IJoinColumn-»
		«ENDIF»
		)
	«ENDIF»
«ENDDEFINE»

«REM»
	parts of the xpand evaluation of the model, should no longer be needed cause this takes place in xtend now
«ENDREM»
«REM»
	evaluates association stereotype
	at the moment called in root template of jpa-cartridge
	in future it should be called from aspects.xpt extending the root template of the java5-cartridge
	for only use of java5-cartridge the seam2 cartridge has to be changed too!!!
«DEFINE _AssociationStereotypeExists FOR MAssociationRole-»
«ENDREM»
		«REM»
			lines of code are in new define block evaluateAssociationStereotype
	«IF !hasTaggedValue("jpaAssociation", "type", "AutoDetect") && hasUtilizableValue("jpaAssociation", "type")-»
		
			evaluation is easy if stereotype "jpaAssociation" and 
			tagged value "type" are set 
		«IF hasTaggedValue("jpaAssociation", "type", "OneToOne")»
			@OneToOne«EXPAND _EvaluateAssociationTaggedValues-»
		«ENDIF»
		
		«IF hasTaggedValue("jpaAssociation", "type", "OneToMany")»
			@OneToMany«EXPAND _EvaluateAssociationTaggedValues-»
			«EXPAND _JoinTable»
		«ENDIF»
		
		«IF hasTaggedValue("jpaAssociation", "type", "ManyToOne")»
			@ManyToOne«EXPAND _EvaluateAssociationTaggedValues-»
			«EXPAND _JoinTable»
		«ENDIF»
		
		«IF hasTaggedValue("jpaAssociation", "type", "ManyToMany")»
			@ManyToMany«EXPAND _EvaluateAssociationTaggedValues-»
			«EXPAND _JoinTable»
		«ENDIF»			
	«ELSEIF opposite != null-»
		«ENDREM»		«REM» 
	«IF opposite != null-»
		
			even with existing stereotype "jpaAssociation" the tagged value
			"type" does not have to be set if association is bidirectional.
			check if opposite has an association stereotype
		«ENDREM»
			«REM»
		«IF !opposite.hasStereotype("jpaAssociation")-»
				opposite has no stereotype "jpaAssociation"
				set necessary annotation and add value to tagged value "type" for easy
				evaluation of the opposite association later in the generation process. 
				Cannot create stereotype on opposite because it does not work for some reason!!! 
			«ENDREM»
			«REM»
			«IF multiplicity == 1-»
				«IF opposite.multiplicity == 1-»
					«setTaggedValue(this, "type", "OneToOne") ->""-»
					«setTaggedValue(this, "mappedBy", opposite.asAttribute())->""-»
				«ELSE-»
					«setTaggedValue(this, "type", "ManyToOne") ->""-»	
					«setTaggedValue(this, "mappedBy", "null")->""-»				
				«ENDIF-»
			«ELSE-»
				«IF opposite.multiplicity == 1-»
					«setTaggedValue(this, "type", "OneToMany") ->""-»
					«setTaggedValue(this, "mappedBy", opposite.asAttribute())->""-»
				«ELSE-»
					«setTaggedValue(this, "type", "ManyToMany") ->""-»
					«setTaggedValue(this, "mappedBy", opposite.asAttribute())->""-»
				«ENDIF-»				
			«ENDIF-»
			«EXPAND _EvaluateAssociationStereotype»
			«ENDREM»
			«REM»
		«ELSE-»
			«REM»
				only one side of the association (the opposite) have been provided with an stereotype
				by the user, so let's find out what has to be annotated on this side of the association
			«EXPAND _EvaluateOppositeStereotype-»
		«ENDIF-»
	«ENDIF»
«ENDDEFINE»
			«ENDREM»

«REM»
	evaluates association to generate annotations automatically
«DEFINE _AssociationStereotypeNotExists FOR MAssociationRole-»
«ENDREM»
	«REM»
		MAssociationRole has no association stereotype 
		automatic annotation, not possible for unidirectional association because 
		opposite attribute is not available and can not be evaluated
	«ENDREM»
		«REM»
	«IF opposite != null-»
			bidirectional
			check if opposite has an association stereotype
		«IF !opposite.hasStereotype("jpaAssociation")-»
		«ENDREM»
			«REM»
				opposite has no stereotype "jpaAssociation"
				set necessary annotation and add stereotype to the opposite for easy
				evaluation of the opposite association later in the generation process. 
				Generation can not have been there because in this case this association 
				site would have had a stereotype. Tagged value "mappedBy" is set on this 
				site thus no "mappedBy" is set to the new stereotype (exception: @ManyToOne)
			«IF multiplicity == 1-»
				«IF opposite.multiplicity == 1-»
					«addAssociationStereotype(this, "OneToOne", "null", "[]", "DEFAULT", "true", opposite.asAttribute()) ->""-»
					«addAssociationStereotype(opposite, "OneToOne", "null", "[]", "DEFAULT", "true", "null") ->""-»
				«ELSE-»
					«addAssociationStereotype(this, "OneToMany", "null", "[]", "DEFAULT", "true", opposite.asAttribute()) ->""-»
					«addAssociationStereotype(opposite, "ManyToOne", "null", "[]", "DEFAULT", "true", "null") ->""-»
				«ENDIF-»
			«ELSE-»
				«IF opposite.multiplicity == 1-»
					«addAssociationStereotype(this, "ManyToOne", "null", "[]", "DEFAULT", "true", "null") ->""-»
					«addAssociationStereotype(opposite, "OneToMany", "null", "[]", "DEFAULT", "true", asAttribute()) ->""-»
				«ELSE-»
					«addAssociationStereotype(this, "ManyToMany", "null", "[]", "DEFAULT", "true", opposite.asAttribute()) ->""-»
					«addAssociationStereotype(opposite, "ManyToMany", "null", "[]", "DEFAULT", "true", "null") ->""-»					
				«ENDIF-»				
			«ENDIF-»
			«ENDREM»
			«REM»
			«EXPAND _EvaluateAssociationStereotype»
		«ELSE-»
			«ENDREM»
			«REM»
				only the opposite of the association have been provided with an stereotype by the
				user, so let's find out what has to be annotated on this side of the association
			«EXPAND _EvaluateOppositeStereotype-»
		«ENDIF-»		
	«ENDIF»
«ENDDEFINE»
			«ENDREM»

«REM»
	evaluates stereotype "jpaAssociation", tagged value "type" and "mappedBy"
«DEFINE _EvaluateOppositeStereotype FOR MAssociationRole-»
	«IF opposite.hasTaggedValue("jpaAssociation", "type", "AutoDetect") || 
		!opposite.hasUtilizableValue("jpaAssociation", "type")-»
		«IF multiplicity == 1-»
			«IF opposite.multiplicity == 1-»
				«IF !opposite.hasUtilizableValue("jpaAssociation", "mappedBy")-»	
					«IF hasStereotype("jpaAssociation")-»
						«setTaggedValue(this, "mappedBy", opposite.asAttribute()) ->""-»
						«setTaggedValue(this, "type", "OneToOne")->""-»
					«ELSE-»
						«addAssociationStereotype(this, "OneToOne", "null", "[]", "DEFAULT", "true", opposite.asAttribute()) ->""-»
					«ENDIF-»
				«ELSE-»
					«IF hasStereotype("jpaAssociation")-»
						«setTaggedValue(this, "mappedBy", "null") ->""-»
						«setTaggedValue(this, "type", "OneToOne")->""-»
					«ELSE-»
						«addAssociationStereotype(this, "OneToOne", "null", "[]", "DEFAULT", "true", "null") ->""-»
					«ENDIF-»
				«ENDIF-»
				«setTaggedValue(opposite, "type", "OneToOne") ->""-»
			«ELSE-»
				«IF !hasStereotype("jpaAssociation")-»
					«addAssociationStereotype(this, "ManyToOne", "null", "[]", "DEFAULT", "true", "null") ->""-»
				«ELSE-»
					«setTaggedValue(this, "type", "ManyToOne")->""-»
					«setTaggedValue(this, "mappedBy", "null")->""-»
				«ENDIF-»	
				«setTaggedValue(opposite, "type", "OneToMany") ->""-»
				«setTaggedValue(opposite, "mappedBy", asAttribute()) ->""-»
			«ENDIF-»
		«ELSE-»
			«IF opposite.multiplicity == 1-»
				«IF hasStereotype("jpaAssociation")-»
					«setTaggedValue(this, "mappedBy", opposite.asAttribute()) ->""-»
					«setTaggedValue(this, "type", "OneToMany")->""-»
				«ELSE-»
					«addAssociationStereotype(this, "OneToMany", "null", "[]", "DEFAULT", "true", opposite.asAttribute()) ->""-»
				«ENDIF-»
				«setTaggedValue(opposite, "type", "ManyToOne") ->""-»
			«ELSE-»
				«IF !opposite.hasUtilizableValue("jpaAssociation", "mappedBy")-»	
					«IF hasStereotype("jpaAssociation")-»
						«setTaggedValue(this, "mappedBy", opposite.asAttribute()) ->""-»
						«setTaggedValue(this, "type", "ManyToMany")->""-»
					«ELSE-»
						«addAssociationStereotype(this, "ManyToMany", "null", "[]", "DEFAULT", "true", opposite.asAttribute()) ->""-»
					«ENDIF-»
				«ELSE-»
					«IF hasStereotype("jpaAssociation")-»
						«setTaggedValue(this, "mappedBy", "null") ->""-»
						«setTaggedValue(this, "type", "ManyToMany")->""-»
					«ELSE-»
						«addAssociationStereotype(this, "ManyToMany", "null", "[]", "DEFAULT", "true", "null") ->""-»
					«ENDIF-»
				«ENDIF-»
				«setTaggedValue(opposite, "type", "ManyToMany") ->""-»
			«ENDIF-»				
		«ENDIF-»	
	«ELSE-»
		«IF opposite.hasTaggedValue("jpaAssociation", "type", "OneToOne")-»
			«IF !opposite.hasUtilizableValue("jpaAssociation", "mappedBy")-»
				«IF hasStereotype("jpaAssociation")-»
					«setTaggedValue(this, "mappedBy", opposite.asAttribute()) ->""-»
					«setTaggedValue(this, "type", "OneToOne")->""-»
				«ELSE-»
					«addAssociationStereotype(this, "OneToOne", "null", "[]", "DEFAULT", "true", opposite.asAttribute()) ->""-»
				«ENDIF-»
			«ELSE-»
				«addAssociationStereotype(this, "OneToOne", "null", "[]", "DEFAULT", "true", "null") ->""-»
			«ENDIF-»		
		«ELSEIF opposite.hasTaggedValue("jpaAssociation", "type", "OneToMany")-»
			«IF !hasStereotype("jpaAssociation")-»
				«addAssociationStereotype(this, "ManyToOne", "null", "[]", "DEFAULT", "true", "null") ->""-»
			«ELSE-»
				«setTaggedValue(this, "type", "ManyToOne")->""-»
				«setTaggedValue(this, "mappedBy", "null") ->""-»				
			«ENDIF-»	
		«ELSEIF opposite.hasTaggedValue("jpaAssociation", "type", "ManyToOne")-»
			«IF !opposite.hasUtilizableValue("jpaAssociation", "mappedBy")-»
				«IF hasStereotype("jpaAssociation")-»
					«setTaggedValue(this, "type", "OneToMany")->""-»
					«setTaggedValue(this, "mappedBy", opposite.asAttribute()) ->""-»
				«ELSE-»
					«addAssociationStereotype(this, "OneToMany", "null", "[]", "DEFAULT", "true", opposite.asAttribute()) ->""-»
				«ENDIF-»	
			«ELSE-»
				«setTaggedValue(opposite, "mappedBy", "null")->""-»
				«IF !hasStereotype("jpaAssociation")-»
					«addAssociationStereotype(this, "OneToMany", "null", "[]", "DEFAULT", "true", opposite.asAttribute()) ->""-»
				«ELSE-»
					«setTaggedValue(this, "type", "OneToMany")->""-»
					«setTaggedValue(this, "mappedBy", opposite.asAttribute())->""-»
				«ENDIF-»
			«ENDIF-»		
		«ELSEIF opposite.hasTaggedValue("jpaAssociation", "type", "ManyToMany")-»
			«IF !opposite.hasUtilizableValue("jpaAssociation", "mappedBy")-»
				«IF hasStereotype("jpaAssociation")-»
					«setTaggedValue(this, "mappedBy", opposite.asAttribute()) ->""-»
					«setTaggedValue(this, "type", "ManyToMany")->""-»
				«ELSE-»
					«addAssociationStereotype(this, "ManyToMany", "null", "[]", "DEFAULT", "true", opposite.asAttribute()) ->""-»
				«ENDIF-»
			«ELSE-»
				«IF !hasStereotype("jpaAssociation")-»
					«addAssociationStereotype(this, "ManyToMany", "null", "[]", "DEFAULT", "true", "") ->""-»
				«ELSE-»
					«setTaggedValue(this, "type", "ManyToMany")->""-»
					«setTaggedValue(this, "mappedBy", "")->""-»
				«ENDIF-»
			«ENDIF-»		
		«ENDIF-»
	«ENDIF-»
	«REM»
	«EXPAND _EvaluateAssociationStereotype»
«ENDDEFINE»
«ENDREM»
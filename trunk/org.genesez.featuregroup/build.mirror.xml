<?xml version="1.0" encoding="UTF-8"?>
<!--
	Mirror Eclipse Plugins for GeneSEZ Dependencies Repository
	
	@author nihe
-->
<project name="org.genesez.p2mirror" default="publish.mirrored.repository">

	<!-- import ant contrib for usage -->
	<import file="lib/antcontrib.xml"/>
	
	<!-- qualifier replacements -->
	<property environment="env"/>
	<property name="source.repository.url" value="${env.UPDATESITE}"/>
	<property name="plugin.name" value="${env.PLUGIN_NAME}"/>
	<property name="plugin.versions" value="${env.PLUGIN_VERSIONS}"/>
	
	<property name="destination.repository.url" value="http://updatesite.genesez.org/mirror"/>
	<property name="destination.repository.dir" value="/srv/www/vhosts/org.genesez.updatesite/httpdocs/mirror"/>
	<property name="destination.repository.name" value="GeneSEZ Aggregated Repository"/>
	
	<property name="eclipse.home" value="/opt/genesez/build/eclipse/RELEASE_LATEST"/>
	
	
	<target name="mirror.plugins" description="Mirror Plugins for GeneSEZ Depencencies Repository">
		<for list="${plugin.versions}" param="plugin.version">
			<sequential>
				<p2.mirror validate="true">
					<repository location="file:${destination.repository.dir}/${plugin.name}/@{plugin.version}" name="${destination.repository.name}"/>
					<source>
						<repository location="${source.repository.url}"/>
					</source>
					<slicingOptions followStrict="false"/>
					<iu id="${plugin.name}" version="@{plugin.version}"/>
				</p2.mirror>
			</sequential>
		</for>
	</target>
	
	<target name="mirror.plugins.internal">
		<antcall target="mirror.plugins" />
	</target>
	
	<target name="mirror.plugins.external">
		<exec executable="${eclipse.home}/eclipse">
			<arg value="-noSplash"/>
			<arg value="-data"/>
			<arg value="${destination.repository.dir}"/>
			<arg value="-application"/>
			<arg value="org.eclipse.ant.core.antRunner"/>
			<arg value="-buildfile"/>
			<arg value="${ant.file}"/>
			<arg value="mirror.plugins"/>
		</exec>
	</target>
	
	
	<target name="aggregate.composite.repository">
		<echo message="Aggregate p2 composite repository containing Eclipse plugins needed by GeneSEZ."/>

		<delete>
			<fileset dir="${destination.repository.dir}">
			    <include name="*.jar"/>
				<include name="*/*.jar"/>
			</fileset>
		</delete>
		
		<for param="directory">
			<path>
				<dirset dir="${destination.repository.dir}">
					<include name="*/*"/>
					<exclude name="*/.*"/>
				</dirset>
			</path>
			<sequential>
				<var name="plugin.dir" unset="true"/>
				<propertyregex property="plugin.dir" input="@{directory}" regexp="${destination.repository.dir}/(.*)" select="\1"/>
				
				<echo message="... add ${plugin.dir}"/>
				
				<p2.composite.repository>
					<repository location="file:${destination.repository.dir}" name="${destination.repository.name}"/>
					<add>
						<repository location="${destination.repository.url}/${plugin.dir}"/>
					</add>
				</p2.composite.repository>
			</sequential>
		</for>
	</target>
	
	<target name="aggregate.composite.repository.internal">
		<antcall target="aggregate.composite.repository" />
	</target>
	
	<target name="aggregate.composite.repository.external">
		<exec executable="${eclipse.home}/eclipse">
			<arg value="-noSplash"/>
			<arg value="-data"/>
			<arg value="${destination.repository.dir}"/>
			<arg value="-application"/>
			<arg value="org.eclipse.ant.core.antRunner"/>
			<arg value="-buildfile"/>
			<arg value="${ant.file}"/>
			<arg value="aggregate.composite.repository"/>
		</exec>
	</target>
		
	<target name="publish.mirrored.repository" depends="mirror.plugins.external, aggregate.composite.repository.external">
		<chmod perm="u=rwX,g=rwX,o=" dir="${destination.repository.dir}" includes="**/*" type="both"/>
		<chgrp group="wwwcln" type="both">
			<fileset dir="${destination.repository.dir}" includes="**/*"/>
		</chgrp>
	</target>

</project>
